{% extends 'base.html.twig' %}

{% block title %}Liste des items - Pax Dei Market{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css">
    <style>
        .item-icon { 
            width: 40px; 
            height: 40px; 
            object-fit: contain;
            border-radius: var(--radius-sm);
        }
        .map-button {
            margin: 0 5px;
        }
        .map-button.active {
            font-weight: bold;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>üì¶ Liste des Items</h1>
            <p class="text-muted">{{ items|length }} items disponibles</p>
        </div>
        <a href="{{ path('market_categories') }}" class="btn btn-info">üìä Cat√©gories</a>
    </div>
    
    <div class="section-divider"></div>
    
    {# Boutons pour choisir la map #}
    <div class="mb-4 text-center">
        <div class="btn-group" role="group" aria-label="Maps">
            {% for mapName in availableMaps %}
                <a href="{{ path('market_items', {'map': mapName}) }}" 
                   class="btn btn-outline-primary map-button {% if mapName == currentMap %}active{% endif %}"
                   data-map="{{ mapName }}">
                    {{ mapName|upper }}
                </a>
            {% endfor %}
        </div>
    </div>
    
    <div class="card">
        <div class="card-body">
            <table id="itemsTable" class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Ic√¥ne</th>
                        <th>Nom</th>
                        <th>Raret√©</th>
                        <th>Cat√©gorie</th>
                        {% for region in regions %}
                            <th class="text-center">{{ region }}</th>
                        {% endfor %}
                        <th class="text-center">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in items %}
                        {% set itemId = item.getExternalId() %}
                        {% set itemCounts = listingCounts[itemId] ?? {} %}
                        {% set total = itemCounts|length > 0 ? itemCounts|reduce((carry, count) => carry + count, 0) : 0 %}
                        {% set isRelic = item.getCategory() and item.getCategory().getName() == 'Reliques' %}
                        {% set isStocked = item.getId() in stockedItemIds %}
                        {% set isMissingRelic = isRelic and not isStocked %}
                        {% if total > 0 %}
                        <tr {% if isMissingRelic %}class="table-warning"{% endif %}>
                            <td>
                                {% if isMissingRelic %}
                                    <span class="position-relative">
                                        <img src="{{ item.getIconPath() }}" alt="{{ item.getName()['Fr'] ?? item.getName()['En'] ?? item.getExternalId() }}" width="32" height="32" loading="lazy">
                                        <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" title="Relique manquante dans le stock de guilde !">
                                            ‚ö†Ô∏è
                                        </span>
                                    </span>
                                {% else %}
                                    <img src="{{ item.getIconPath() }}" alt="{{ item.getName()['Fr'] ?? item.getName()['En'] ?? item.getExternalId() }}" width="32" height="32" loading="lazy">
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ item.getUrl() }}" target="_blank" class="text-decoration-none text-reset">
                                    <span class="{% if item.getQuality() == 'rare' %}text-primary fw-bold{% elseif item.getQuality() == 'uncommon' %}text-success fw-bold{% endif %}">
                                        {{ item.getName()['Fr'] ?? item.getName()['En'] ?? item.getExternalId() }}
                                        {% if isMissingRelic %}
                                            <span class="badge bg-danger ms-2">RELIQUE MANQUANTE</span>
                                        {% endif %}
                                    </span>
                                </a>
                            </td>
                            <td data-order="{% if item.getQuality() == 'rare' %}1{% elseif item.getQuality() == 'uncommon' %}2{% else %}3{% endif %}">
                                {% if item.getQuality() == 'rare' %}
                                    <span class="badge bg-primary">Rare</span>
                                {% elseif item.getQuality() == 'uncommon' %}
                                    <span class="badge bg-success">Uncommon</span>
                                {% else %}
                                    <span class="badge bg-secondary">Common</span>
                                {% endif %}
                            </td>
                            <td>
                                {% if item.getCategory() %}
                                    <span class="badge bg-secondary">{{ item.getCategory().getName() }}</span>
                                {% else %}
                                    <span class="badge bg-light text-dark">Sans cat√©gorie</span>
                                {% endif %}
                            </td>
                            {% for region in regions %}
                                <td class="text-center">
                                    {% if itemCounts[region] is defined and itemCounts[region] > 0 %}
                                        <a href="{{ path('market_item_region_details', {itemId: itemId, region: region, map: currentMap, returnUrl: path('market_items', {map: currentMap})}) }}" class="badge bg-success text-decoration-none">
                                            {{ itemCounts[region] }}
                                        </a>
                                    {% else %}
                                        <span class="badge bg-light text-dark">0</span>
                                    {% endif %}
                                </td>
                            {% endfor %}
                            <td class="text-center">
                                <a href="{{ path('market_item_all_regions', {itemId: item.getExternalId(), map: currentMap, returnUrl: path('market_items', {map: currentMap})}) }}" class="text-decoration-none">
                                    <strong>{{ total }}</strong>
                                </a>
                            </td>
                        </tr>
                        {% endif %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <script>
        $(document).ready(function() {
            var table = $('#itemsTable').DataTable({
                "pageLength": 25,
                "order": [],  // Pas de tri automatique, garder l'ordre du serveur (par raret√©)
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json"
                },
                "columnDefs": [
                    { "orderable": false, "targets": 0 }  // Ic√¥ne non triable
                ],
                "initComplete": function() {
                    // Ajouter un multiselect pour la colonne cat√©gorie (index 2)
                    this.api().columns([2]).every(function() {
                        var column = this;
                        var select = $('<select multiple id="category-filter" placeholder="Filtrer par cat√©gorie..."></select>')
                            .appendTo($(column.header()));
                        
                        // R√©cup√©rer toutes les cat√©gories uniques
                        var categories = [];
                        column.data().unique().sort().each(function(d, j) {
                            // Extraire le texte du badge
                            var text = $(d).text().trim();
                            if (categories.indexOf(text) === -1) {
                                categories.push(text);
                            }
                        });
                        
                        categories.forEach(function(cat) {
                            select.append('<option value="' + cat + '">' + cat + '</option>');
                        });
                        
                        // Initialiser Tom Select
                        new TomSelect('#category-filter', {
                            plugins: ['remove_button'],
                            placeholder: 'Toutes les cat√©gories',
                            onChange: function(values) {
                                if (values.length === 0) {
                                    column.search('').draw();
                                } else {
                                    var vals = values.map(function(v) {
                                        return $.fn.dataTable.util.escapeRegex(v);
                                    });
                                    column.search(vals.join('|'), true, false).draw();
                                }
                            }
                        });
                    });
                }
            });
        });
    </script>
{% endblock %}
