{% extends 'base.html.twig' %}

{% block title %}{{ view.name }} - Pax Dei Market{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.css">
    <style>
        .map-button {
            margin: 0 5px;
        }
        .map-button.active {
            font-weight: bold;
        }
        .region-col {
            font-size: 0.85rem;
            padding: 0.4rem !important;
            white-space: nowrap;
            min-width: 70px;
        }
        #itemsTable thead th {
            font-size: 0.9rem;
        }
    </style>
{% endblock %}

{% block body %}
<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h1>üìã {{ view.name }}</h1>
            <p class="text-muted">
                {{ view.categories|length }} cat√©gorie(s) ‚Ä¢ 
                {{ view.items|length }} item(s) sp√©cifique(s) ‚Ä¢ 
                {{ items|length }} item(s) total
            </p>
        </div>
        <div>
            <a href="{{ path('app_profile_view_edit', {id: view.id}) }}" class="btn btn-secondary">
                ‚úèÔ∏è Modifier
            </a>
            <a href="{{ path('app_profile') }}" class="btn btn-outline-secondary">
                ‚¨ÖÔ∏è Retour au profil
            </a>
        </div>
    </div>

    <div class="section-divider"></div>

    {# Boutons pour choisir la map #}
    <div class="mb-4 text-center">
        <div class="btn-group" role="group" aria-label="Maps">
            {% for mapName in availableMaps %}
                <a href="{{ path('app_view_show', {'id': view.id, 'map': mapName}) }}" 
                   class="btn btn-outline-primary map-button {% if mapName == currentMap %}active{% endif %}"
                   data-map="{{ mapName }}">
                    {{ mapName|upper }}
                </a>
            {% endfor %}
        </div>
    </div>

    {% if items|length > 0 %}
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                <table id="itemsTable" class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th>Ic√¥ne</th>
                            <th>Nom</th>
                            <th>Raret√©</th>
                            <th>Cat√©gorie</th>
                            <th class="text-center">Prix min</th>
                            <th class="text-center">Prix unit. min</th>
                            {% for region in regions %}
                                <th class="text-center region-col">{{ region }}</th>
                            {% endfor %}
                            <th class="text-center">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in items %}
                            {% set itemCounts = listingCounts[item.externalId] ?? {} %}
                            {% set total = itemCounts|length > 0 ? itemCounts|reduce((carry, count) => carry + count, 0) : 0 %}
                            {% set isRelic = item.category and item.category.name == 'Reliques' %}
                            {% set isStocked = item.id in stockedItemIds %}
                            {% set isMissingRelic = isRelic and not isStocked %}
                            {% if total > 0 %}
                            <tr {% if isMissingRelic %}class="table-warning"{% endif %}>
                                <td>
                                    {% if isMissingRelic %}
                                        <span class="position-relative">
                                            <img src="{{ item.iconPath }}" alt="{{ item.name['fr'] ?? item.name['en'] ?? item.externalId }}" width="32" height="32" loading="lazy">
                                            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" title="Relique manquante dans le stock de guilde !">
                                                ‚ö†Ô∏è
                                            </span>
                                        </span>
                                    {% else %}
                                        <img src="{{ item.iconPath }}" alt="{{ item.name['fr'] ?? item.name['en'] ?? item.externalId }}" width="32" height="32" loading="lazy">
                                    {% endif %}
                                </td>
                                <td>
                                    <a href="{{ item.url }}" target="_blank" class="text-decoration-none text-reset">
                                        <span class="{% if item.quality == 'rare' %}text-primary fw-bold{% elseif item.quality == 'uncommon' %}text-success fw-bold{% endif %}">
                                            {{ item.name['Fr'] ?? item.name['fr'] ?? item.name['En'] ?? item.name['en'] ?? item.externalId }}
                                            {% if isMissingRelic %}
                                                <span class="badge bg-danger ms-2">RELIQUE MANQUANTE</span>
                                            {% endif %}
                                        </span>
                                    </a>
                                </td>
                                <td data-order="{% if item.quality == 'rare' %}1{% elseif item.quality == 'uncommon' %}2{% else %}3{% endif %}">
                                    {% if item.quality == 'rare' %}
                                        <span class="badge bg-primary">Rare</span>
                                    {% elseif item.quality == 'uncommon' %}
                                        <span class="badge bg-success">Uncommon</span>
                                    {% else %}
                                        <span class="badge bg-secondary">Common</span>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if item.category %}
                                        <span class="badge bg-secondary">{{ item.category.name }}</span>
                                    {% else %}
                                        <span class="badge bg-light text-dark">Sans cat√©gorie</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if minPrices[item.externalId] is defined %}
                                        <span class="text-success fw-bold">{{ minPrices[item.externalId].total|number_format(2) }}ü™ô</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    {% if minPrices[item.externalId] is defined %}
                                        <span class="text-info fw-bold">{{ minPrices[item.externalId].unit|number_format(2) }}ü™ô</span>
                                        <small class="text-muted d-block">(x{{ minPrices[item.externalId].quantity }})</small>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                {% for region in regions %}
                                    <td class="text-center region-col">
                                        {% if itemCounts[region] is defined and itemCounts[region] > 0 %}
                                            <a href="{{ path('market_item_region_details', {itemId: item.externalId, region: region, map: currentMap, returnUrl: path('app_view_show', {id: view.id, map: currentMap})}) }}" class="badge bg-success text-decoration-none">
                                                {{ itemCounts[region] }}
                                            </a>
                                        {% else %}
                                            <span class="badge bg-light text-dark">0</span>
                                        {% endif %}
                                    </td>
                                {% endfor %}
                                <td class="text-center">
                                    <a href="{{ path('market_item_all_regions', {itemId: item.externalId, map: currentMap, returnUrl: path('app_view_show', {id: view.id, map: currentMap})}) }}" class="text-decoration-none">
                                        <strong>{{ total }}</strong>
                                    </a>
                                </td>
                            </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>
                </div>
            </div>
        </div>
    {% else %}
        <div class="alert alert-info">
            <h5>Aucun item dans cette vue</h5>
            <p class="mb-0">
                Cette vue ne contient aucun item. 
                <a href="{{ path('app_profile_view_edit', {id: view.id}) }}">Modifiez-la</a> pour ajouter des cat√©gories ou des items.
            </p>
        </div>
    {% endif %}
</div>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>
    <script>
        $(document).ready(function() {
            var table = $('#itemsTable').DataTable({
                "pageLength": 25,
                "order": [],  // Pas de tri automatique, garder l'ordre du serveur (par raret√©)
                "scrollX": true,
                "autoWidth": false,
                "language": {
                    "url": "//cdn.datatables.net/plug-ins/1.13.7/i18n/fr-FR.json"
                },
                "columnDefs": [
                    { "orderable": false, "targets": 0 }  // Ic√¥ne non triable
                ],
                "initComplete": function() {
                    // Ajouter un multiselect pour la colonne cat√©gorie (index 2)
                    this.api().columns([2]).every(function() {
                        var column = this;
                        var select = $('<select multiple id="category-filter" placeholder="Filtrer par cat√©gorie..."></select>')
                            .appendTo($(column.header()));
                        
                        // R√©cup√©rer toutes les cat√©gories uniques
                        var categories = [];
                        column.data().unique().sort().each(function(d, j) {
                            // Extraire le texte du badge
                            var text = $(d).text().trim();
                            if (categories.indexOf(text) === -1) {
                                categories.push(text);
                            }
                        });
                        
                        categories.forEach(function(cat) {
                            select.append('<option value="' + cat + '">' + cat + '</option>');
                        });
                        
                        // Initialiser Tom Select
                        new TomSelect('#category-filter', {
                            plugins: ['remove_button'],
                            placeholder: 'Toutes les cat√©gories',
                            onChange: function(values) {
                                if (values.length === 0) {
                                    column.search('').draw();
                                } else {
                                    var vals = values.map(function(v) {
                                        return $.fn.dataTable.util.escapeRegex(v);
                                    });
                                    column.search(vals.join('|'), true, false).draw();
                                }
                            }
                        });
                    });
                }
            });
        });
    </script>
{% endblock %}
